version: '3'

vars:
  BWS_ACCESS_TOKEN: "${BWS_ACCESS_TOKEN}"
  BWS_PROJECT_ID: "${BWS_PROJECT_ID}"

tasks:
  check-bws:
    desc: Check Bitwarden Secrets Manager configuration
    silent: true
    cmds:
      - ./scripts/task/secrets/check-bws-config.sh

  list-secrets:
    desc: List all secrets in the configured Bitwarden project
    deps: [check-bws]
    cmds:
      - bws secret list {{.BWS_PROJECT_ID}}

  get-secret:
    desc: Get a specific secret by name (SECRET_NAME=secret_name)
    deps: [check-bws]
    cmds:
      - ./scripts/task/secrets/manage-secret.sh get {{.SECRET_NAME}}

  create-secret:
    desc: Create a new secret (SECRET_NAME=name SECRET_VALUE=value)
    deps: [check-bws]
    cmds:
      - ./scripts/task/secrets/manage-secret.sh create {{.SECRET_NAME}} {{.SECRET_VALUE}}

  update-secret:
    desc: Update an existing secret (SECRET_NAME=name SECRET_VALUE=value)
    deps: [check-bws]
    cmds:
      - ./scripts/task/secrets/manage-secret.sh update {{.SECRET_NAME}} {{.SECRET_VALUE}}

  delete-secret:
    desc: Delete a secret (SECRET_NAME=name)
    deps: [check-bws]
    cmds:
      - ./scripts/task/secrets/manage-secret.sh delete {{.SECRET_NAME}}

  doctor:
    desc: Run comprehensive Bitwarden Secrets health check
    cmds:
      - ./scripts/task/secrets/doctor.sh

  auth:
    desc: Check that all required secrets exist for current network/environment/service
    deps: [check-bws]
    cmds:
      - ./scripts/task/secrets/auth.sh

  resolve:
    desc: Resolve a secret using precedence hierarchy (SECRET_ITEM=GITLAB_API_KEY)
    cmds:
      - ./scripts/task/secrets/resolve-secret.sh {{.SECRET_ITEM}}